<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Firelight Duel Academy | Modern Yu-Gi-Oh! TCG Store</title>
    <meta name="description" id="page-description" content="Your premier destination for Yu-Gi-Oh! single cards, competitive play, and tournament events. Modern TCG store with real-time pricing and advanced search.">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/css/modern-tcg-store.css">
    <link rel="stylesheet" href="assets/css/mobile.css">
    <link rel="icon" href="assets/images/firelight-logo.svg" type="image/svg+xml">
    <link rel="icon" href="assets/images/f3c4e91c-8a34-4545-a53a-489b4eb181c4.jpg" type="image/jpeg">
    
    <!-- Meta tags for SEO -->
    <meta property="og:title" id="og-title" content="Firelight Duel Academy - Modern Yu-Gi-Oh! TCG Store">
    <meta property="og:description" id="og-description" content="Premium Yu-Gi-Oh! singles, competitive pricing, and tournament events.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="assets/images/f3c4e91c-8a34-4545-a53a-489b4eb181c4.jpg">
</head>
<body>
    <!-- 401Games-Style Header -->
    <header class="modern-header">
        <!-- Top Bar -->
        <div class="header-top">
            <div class="header-top-container">
                <div class="header-top-left">
                    <a href="tel:647-555-DUEL" class="header-top-link"><i class="fas fa-phone"></i> (647) 555-DUEL</a>
                    <a href="mailto:support@firelightduelacademy.com" class="header-top-link"><i class="fas fa-envelope"></i> Support</a>
                    <!-- Tournaments link hidden - store not hosting events -->
                    <!-- <a href="#" class="header-top-link" onclick="navigateTo('events')"><i class="fas fa-trophy"></i> Tournaments</a> -->
                </div>
                <div class="header-top-right">
                    <!-- Currency Toggle -->
                    <div class="currency-toggle" style="display: inline-flex; align-items: center; gap: var(--space-2); margin-right: var(--space-4);">
                        <span style="font-size: 0.875rem; color: white; font-weight: 500;">Currency:</span>
                        <button id="currency-toggle-btn" onclick="toggleCurrency()" style="background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: var(--radius-md); padding: var(--space-1) var(--space-3); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; color: white;">
                            CAD
                        </button>
                    </div>
                    <span><i class="fas fa-shipping-fast"></i> Free Shipping on Orders $100+ CAD</span>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <div class="header-main">
            <div class="header-container">
                <!-- Brand Section -->
                <div class="brand-section">
                    <!-- Firelight Logo SVG -->
                    <svg width="50" height="50" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg" class="brand-logo">
                        <defs>
                            <linearGradient id="headerFireGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FF6B35;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#F7931E;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FFD23F;stop-opacity:1" />
                            </linearGradient>
                            <filter id="headerGlow">
                                <feGaussianBlur stdDeviation="1" result="coloredBlur"/>
                                <feMerge> 
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Main flame -->
                        <path d="M30 45 C30 35, 20 30, 20 20 C20 15, 25 10, 30 15 C35 10, 40 15, 40 20 C40 30, 30 35, 30 45 Z" 
                              fill="url(#headerFireGradient)" filter="url(#headerGlow)"/>
                        <!-- Inner flame -->
                        <path d="M30 40 C30 32, 25 28, 25 22 C25 18, 28 15, 30 18 C32 15, 35 18, 35 22 C35 28, 30 32, 30 40 Z" 
                              fill="#FFE066" opacity="0.8"/>
                        <!-- Core flame -->
                        <path d="M30 35 C30 30, 27 27, 27 24 C27 22, 28.5 20, 30 22 C31.5 20, 33 22, 33 24 C33 27, 30 30, 30 35 Z" 
                              fill="#FFF2CC" opacity="0.9"/>
                    </svg>
                    <div class="brand-text">
                        <a href="#" class="brand-name" onclick="navigateTo('home')">Firelight Duel Academy</a>
                        <span class="brand-tagline">Yu-Gi-Oh! Singles & Tournament Store</span>
                    </div>
                </div>

                <!-- Navigation Section -->
                <nav class="nav-section">
                    <ul class="nav-links">
                        <li><a href="#" class="nav-link" id="nav-home" onclick="navigateTo('home')">Home</a></li>
                        
                        <!-- Singles Dropdown -->
                        <li class="nav-dropdown">
                            <a href="#" class="nav-link dropdown-toggle" id="nav-singles">
                                Singles <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </a>
                            <div class="dropdown-menu">
                                <a href="#" class="dropdown-item" onclick="navigateTo('singles', '?game=yugioh')">
                                    <i class="game-icon yugioh-icon">üÉè</i>
                                    Yu-Gi-Oh! Singles
                                </a>
                                <a href="#" class="dropdown-item" onclick="navigateTo('singles', '?game=pokemon')">
                                    <i class="game-icon pokemon-icon">‚ö°</i>
                                    Pokemon Singles
                                </a>
                            </div>
                        </li>
                        
                        <li><a href="#" class="nav-link" id="nav-sealed" onclick="navigateTo('sealed')">Sealed</a></li>
                        
                        <!-- Decks Dropdown -->
                        <li class="nav-dropdown">
                            <a href="#" class="nav-link dropdown-toggle" id="nav-decks">
                                Decks <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </a>
                            <div class="dropdown-menu">
                                <a href="#" class="dropdown-item" onclick="navigateTo('decks', '?game=yugioh')">
                                    <i class="game-icon yugioh-icon">üÉè</i>
                                    Yu-Gi-Oh! Decks
                                </a>
                                <a href="#" class="dropdown-item" onclick="navigateTo('decks', '?game=pokemon')">
                                    <i class="game-icon pokemon-icon">‚ö°</i>
                                    Pokemon Decks
                                </a>
                            </div>
                        </li>
                        
                        <li><a href="#" class="nav-link" id="nav-buylist" onclick="navigateTo('buylist')">Buylist</a></li>
                        <!-- Events hidden - store not hosting events -->
                        <li style="display: none;"><a href="#" class="nav-link" id="nav-events" onclick="navigateTo('events')">Events</a></li>
                        <!-- Account navigation removed - access via account button only -->
                    </ul>
                </nav>

                <!-- Search Section -->
                <div class="search-section">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="text" class="search-input" placeholder="Search Yu-Gi-Oh! cards..." id="search-dropdown-input">
                        <div class="search-dropdown" id="search-dropdown" style="display: none;">
                            <div class="search-results" id="search-results">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Section -->
                <div class="action-section">
                    <button class="action-btn" onclick="handleWishlistClick()">
                        <i class="fas fa-heart"></i> <span>Wishlist</span>
                        <span class="wishlist-badge" style="display: none;">0</span>
                    </button>
                    <button class="action-btn" onclick="tcgStore.openCart()">
                        <i class="fas fa-shopping-cart"></i> <span>Cart</span>
                        <span class="cart-badge" style="display: none;">0</span>
                    </button>
                    <a href="#" class="action-btn" id="account-btn" onclick="handleAccountClick()">
                        <i class="fas fa-user"></i> <span>Account</span>
                    </a>
                </div>

                <!-- Mobile Navigation Toggle -->
                <button class="mobile-nav-toggle" onclick="toggleMobileNav()" aria-label="Toggle navigation menu">
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Menu -->
    <nav class="mobile-nav-menu" id="mobile-nav-menu">
        <!-- Mobile Search -->
        <div class="mobile-search">
            <div class="search-container">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" placeholder="Search Yu-Gi-Oh! cards..." id="mobile-search-input">
            </div>
        </div>
        
        <!-- Mobile Navigation Links -->
        <ul class="mobile-nav-links">
            <li><a href="#" class="mobile-nav-link" id="mobile-nav-home" onclick="navigateTo('home'); closeMobileNav();">
                <i class="fas fa-home"></i> Home
            </a></li>
            <li><a href="#" class="mobile-nav-link" id="mobile-nav-singles" onclick="navigateTo('singles'); closeMobileNav();">
                <i class="fas fa-cards-blank"></i> Singles
            </a></li>
            <li><a href="#" class="mobile-nav-link" id="mobile-nav-decks" onclick="navigateTo('decks'); closeMobileNav();">
                <i class="fas fa-layer-group"></i> Decks
            </a></li>
            <li><a href="#" class="mobile-nav-link" id="mobile-nav-buylist" onclick="navigateTo('buylist'); closeMobileNav();">
                <i class="fas fa-dollar-sign"></i> Buylist
            </a></li>
            <li><a href="#" class="mobile-nav-link" id="mobile-nav-account" onclick="handleAccountClick(); closeMobileNav();">
                <i class="fas fa-user"></i> My Account
            </a></li>
            <li><a href="#" class="mobile-nav-link" onclick="handleWishlistClick(); closeMobileNav();">
                <i class="fas fa-heart"></i> Wishlist
            </a></li>
            <li><a href="#" class="mobile-nav-link" onclick="tcgStore.openCart(); closeMobileNav();">
                <i class="fas fa-shopping-cart"></i> Shopping Cart
            </a></li>
        </ul>
    </nav>

    <!-- Dynamic Content Container -->
    <main id="main-content" style="width: 100%; margin: 0 auto; padding: var(--space-8) var(--space-8); min-height: 60vh;">
        <!-- Page content will be loaded here dynamically -->
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading...</p>
        </div>
    </main>

    <!-- 401Games-Style Footer -->
    <footer class="modern-footer">
        <div class="footer-main">
            <div class="footer-container">
                
                <!-- Store Features -->
                <div class="footer-features">
                    <div class="footer-feature">
                        <div class="footer-feature-icon"><i class="fas fa-shipping-fast"></i></div>
                        <h4>Fast & Free Shipping</h4>
                        <p>Free shipping on orders $75+ CAD. Expedited shipping to Canada and USA.</p>
                    </div>
                    <!-- Community Events feature hidden - store not hosting events -->
                    <!--
                    <div class="footer-feature">
                        <div class="footer-feature-icon"><i class="fas fa-trophy"></i></div>
                        <h4>Community Events</h4>
                        <p>Daily events at our store! From casual to competitive, we have something for everyone.</p>
                    </div>
                    -->
                    <div class="footer-feature">
                        <div class="footer-feature-icon"><i class="fas fa-dollar-sign"></i></div>
                        <h4>Competitive Pricing</h4>
                        <p>Real-time market pricing powered by YGOPRODeck API ensures the best deals.</p>
                    </div>
                    <div class="footer-feature">
                        <div class="footer-feature-icon"><i class="fas fa-shield-alt"></i></div>
                        <h4>Secure Shopping</h4>
                        <p>Safe and secure checkout with multiple payment options and buyer protection.</p>
                    </div>
                </div>

                <!-- Store Locations -->
                <div class="store-locations">
                    <div class="store-location">
                        <h4>Firelight Academy - Main</h4>
                        <p>1247 Queen Street West, Toronto, Ontario</p>
                        <p>Queen & Dovercourt Intersection</p>
                        <a href="tel:647-555-DUEL" class="store-phone">(647) 555-DUEL</a>
                    </div>
                    <div class="store-location">
                        <h4>Firelight Academy - North</h4>
                        <p>8850 Yonge Street, Richmond Hill, Ontario</p>
                        <p>Yonge & Major Mackenzie Intersection</p>
                        <a href="tel:905-555-FIRE" class="store-phone">(905) 555-FIRE</a>
                    </div>
                </div>

                <!-- Footer Links -->
                <div class="footer-grid">
                    <div class="footer-section">
                        <h3>Firelight Duel Academy</h3>
                        <p>Your premier destination for Yu-Gi-Oh! singles, competitive play, and tournament events. We pride ourselves on providing the best selection and prices in Canada.</p>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="#" onclick="navigateTo('singles')">Yu-Gi-Oh! Singles</a></li>
                            <li><a href="#" onclick="navigateTo('decks')">Popular Decks</a></li>
                            <!-- Tournament Events link hidden - store not hosting events -->
                            <!-- <li><a href="#" onclick="navigateTo('events')">Tournament Events</a></li> -->
                            <li><a href="#" onclick="navigateTo('account')">My Account</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Customer Service</h3>
                        <ul class="footer-links">
                            <li><a href="mailto:info@firelightduelacademy.com">Contact Us</a></li>
                            <li><a href="#" onclick="navigateTo('shipping-policy')">Shipping Policy</a></li>
                            <li><a href="#" onclick="navigateTo('return-policy')">Return Policy</a></li>
                            <li><a href="#" onclick="navigateTo('faq')">FAQ</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Connect</h3>
                        <ul class="footer-links">
                            <li><a href="#">Facebook</a></li>
                            <li><a href="#">Instagram</a></li>
                            <li><a href="#">Twitter</a></li>
                            <li><a href="#">Discord</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-container">
                <p>&copy; 2025 Firelight Duel Academy. All rights reserved. | Yu-Gi-Oh! is a trademark of Konami Digital Entertainment.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="assets/js/services/database-service.js"></script>
    <script src="assets/js/services/yugioh-pricing-service.js"></script>
    <script src="assets/js/database-init.js"></script>
    <script src="assets/js/services/deck-builder-service.js"></script>
    <script src="assets/js/app-router.js"></script>
    <script src="assets/js/modern-tcg-store.js"></script>
    
    <!-- Global Product Page Functions -->
    <script>
        // Global functions for product page functionality
        function changeProductQuantity(delta) {
            const quantityInput = document.getElementById('product-quantity');
            if (quantityInput) {
                const currentValue = parseInt(quantityInput.value) || 1;
                const newValue = Math.max(1, Math.min(99, currentValue + delta));
                quantityInput.value = newValue;
            }
        }

        function addProductToCart(cardName, basePrice, image) {
            if (window.tcgStore) {
                const quantity = parseInt(document.getElementById('product-quantity')?.value) || 1;
                const condition = parseFloat(document.getElementById('product-condition')?.value) || 1.0;
                
                // Get selected set data if available
                const selectedSetData = window.selectedSetData || {};
                const finalPrice = selectedSetData.price ? 
                    (parseFloat(selectedSetData.price) * condition).toFixed(2) : 
                    (basePrice * condition).toFixed(2);
                
                for (let i = 0; i < quantity; i++) {
                    window.tcgStore.addToCartWithDetails(
                        cardName, 
                        finalPrice, 
                        image,
                        selectedSetData.setCode || '',
                        selectedSetData.rarity || '',
                        selectedSetData.setName || ''
                    );
                }
            }
        }

        function openImageZoom(imageSrc, altText) {
            const modal = document.getElementById('image-zoom-modal');
            const zoomedImage = document.getElementById('zoomed-image');
            
            if (modal && zoomedImage) {
                zoomedImage.src = imageSrc;
                zoomedImage.alt = altText;
                modal.style.display = 'flex';
            }
        }

        function closeImageZoom() {
            const modal = document.getElementById('image-zoom-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Set selection functionality for product pages
        function selectSet(setCode, rarity, price, setName) {
            // Update all set options to remove selected state
            document.querySelectorAll('.set-option').forEach(option => {
                option.style.border = '2px solid var(--gray-300)';
                option.style.background = 'white';
                option.style.color = 'var(--gray-900)';
                option.classList.remove('selected');
            });

            // Mark the clicked option as selected
            event.target.closest('.set-option').style.border = '2px solid var(--primary-color)';
            event.target.closest('.set-option').style.background = 'var(--primary-color)';
            event.target.closest('.set-option').style.color = 'white';
            event.target.closest('.set-option').classList.add('selected');

            // Update the main price display
            const priceElement = document.querySelector('[style*="font-size: 2rem"][style*="font-weight: 700"][style*="color: var(--primary-color)"]');
            if (priceElement) {
                priceElement.textContent = `$${price}`;
            }

            // Update the rarity badge
            const rarityBadge = document.querySelector('[style*="background: var(--secondary-color)"]');
            if (rarityBadge) {
                rarityBadge.textContent = rarity;
            }

            // Store selected set data for cart functionality
            window.selectedSetData = {
                setCode: setCode,
                rarity: rarity,
                price: price,
                setName: setName
            };
        }

        // Account functionality
        function handleAccountClick() {
            console.log('Account button clicked'); // Debug log
            
            // Check if user is logged in and validate account
            if (window.tcgStore && window.tcgStore.currentUser) {
                console.log('User is logged in, validating...'); // Debug log
                // Validate that the user account still exists
                if (window.tcgStore.validateCurrentUser()) {
                    // User is valid, navigate to account page
                    console.log('User validated, navigating to account page'); // Debug log
                    if (typeof navigateTo === 'function') {
                        navigateTo('account');
                    } else if (window.appRouter) {
                        window.appRouter.loadPage('account', true);
                    } else {
                        console.error('Navigation functions not available');
                        // Fallback: reload page with hash
                        window.location.hash = '#page=account';
                        window.location.reload();
                    }
                } else {
                    // Account doesn't exist anymore, auto-logout
                    console.warn('User account no longer exists, logging out...');
                    window.tcgStore.logout();
                    if (window.tcgStore.showToast) {
                        window.tcgStore.showToast('Your account session has expired. Please log in again.', 'warning');
                    }
                    if (window.tcgStore.openLoginModal) {
                        window.tcgStore.openLoginModal();
                    }
                }
            } else {
                console.log('User not logged in, showing login modal'); // Debug log
                // User not logged in, show login modal
                if (window.tcgStore && typeof window.tcgStore.openLoginModal === 'function') {
                    window.tcgStore.openLoginModal();
                } else {
                    console.log('Login modal not available, navigating to account page'); // Debug log
                    // Fallback: navigate to account page which will show login prompt
                    if (typeof navigateTo === 'function') {
                        navigateTo('account');
                    } else if (window.appRouter) {
                        window.appRouter.loadPage('account', true);
                    } else {
                        console.error('Navigation functions not available');
                        // Fallback: reload page with hash
                        window.location.hash = '#page=account';
                        window.location.reload();
                    }
                }
            }
        }

        // Initialize account UI when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for tcgStore to be initialized
            setTimeout(() => {
                if (window.tcgStore) {
                    // Validate current user on page load
                    if (window.tcgStore.currentUser && !window.tcgStore.validateCurrentUser()) {
                        console.warn('Invalid user session detected on page load, logging out...');
                        window.tcgStore.logout();
                    }
                    window.tcgStore.updateAccountUI();
                }
            }, 100);
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('image-zoom-modal');
            if (event.target === modal) {
                closeImageZoom();
            }
        });

        // Global FAQ toggle function
        function toggleFAQ(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector('span');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = '‚àí';
                button.setAttribute('aria-expanded', 'true');
            } else {
                content.style.display = 'none';
                icon.textContent = '+';
                button.setAttribute('aria-expanded', 'false');
            }
        }

        // Wishlist functionality
        function handleWishlistClick() {
            if (window.tcgStore && typeof window.tcgStore.openWishlistModal === 'function') {
                window.tcgStore.openWishlistModal();
            } else {
                console.warn('TCG Store not initialized or wishlist function not available');
                // Fallback: show a message or redirect to login
                if (window.tcgStore && typeof window.tcgStore.openLoginModal === 'function') {
                    window.tcgStore.openLoginModal();
                } else {
                    alert('Please log in to access your wishlist.');
                }
            }
        }

        // Mobile Navigation Functions
        function toggleMobileNav() {
            const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            
            if (mobileNavToggle && mobileNavMenu) {
                const isActive = mobileNavToggle.classList.contains('active');
                
                if (isActive) {
                    closeMobileNav();
                } else {
                    openMobileNav();
                }
            }
        }

        function openMobileNav() {
            const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            
            if (mobileNavToggle && mobileNavMenu) {
                mobileNavToggle.classList.add('active');
                mobileNavMenu.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }

        function closeMobileNav() {
            const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            
            if (mobileNavToggle && mobileNavMenu) {
                mobileNavToggle.classList.remove('active');
                mobileNavMenu.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
            
            if (mobileNavMenu && mobileNavToggle) {
                const isClickInsideNav = mobileNavMenu.contains(event.target);
                const isClickOnToggle = mobileNavToggle.contains(event.target);
                
                if (!isClickInsideNav && !isClickOnToggle && mobileNavMenu.classList.contains('active')) {
                    closeMobileNav();
                }
            }
        });

        // Close mobile nav on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const mobileNavMenu = document.getElementById('mobile-nav-menu');
                if (mobileNavMenu && mobileNavMenu.classList.contains('active')) {
                    closeMobileNav();
                }
            }
        });

        // Handle mobile search
        document.addEventListener('DOMContentLoaded', function() {
            const mobileSearchInput = document.getElementById('mobile-search-input');
            if (mobileSearchInput && window.tcgStore) {
                mobileSearchInput.addEventListener('input', window.tcgStore.debounce(function() {
                    // Use the same search functionality as desktop
                    if (window.tcgStore.handleSearchDropdown) {
                        window.tcgStore.handleSearchDropdown();
                    }
                }, 300));
                
                mobileSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = e.target.value.trim();
                        if (query.length >= 2) {
                            closeMobileNav();
                            navigateTo('singles', `?search=${encodeURIComponent(query)}`);
                        }
                    }
                });
            }
        });

        // Update mobile navigation active states
        function updateMobileNavigation(pageName) {
            // Remove active class from all mobile nav links
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Add active class to current page
            const activeMobileLink = document.getElementById(`mobile-nav-${pageName}`);
            if (activeMobileLink) {
                activeMobileLink.classList.add('active');
            }
        }

        // Ensure navigateTo function is always available and reliable
        function ensureNavigateTo() {
            if (!window.navigateTo || typeof window.navigateTo !== 'function') {
                window.navigateTo = function(page, params = '') {
                    console.log('Using fallback navigateTo function for:', page, params);
                    
                    // Close mobile nav when navigating
                    closeMobileNav();
                    
                    // Update mobile navigation
                    updateMobileNavigation(page);
                    
                    // Use app router if available
                    if (window.appRouter && typeof window.appRouter.loadPage === 'function') {
                        window.appRouter.loadPage(page, true, params);
                    } else {
                        // Fallback: use hash-based navigation
                        console.warn('AppRouter not available, using hash fallback');
                        const url = page === 'home' ? '#' : `#page=${page}${params}`;
                        window.location.hash = url;
                        window.location.reload();
                    }
                };
            }
        }

        // Enhanced navigateTo wrapper that handles mobile nav
        function createNavigateToWrapper() {
            const originalNavigateTo = window.navigateTo;
            
            window.navigateTo = function(page, params = '') {
                console.log('NavigateTo called:', page, params);
                
                // Close mobile nav when navigating
                closeMobileNav();
                
                // Update mobile navigation
                updateMobileNavigation(page);
                
                // Call navigation function with multiple fallbacks
                if (originalNavigateTo && typeof originalNavigateTo === 'function') {
                    originalNavigateTo(page, params);
                } else if (window.appRouter && typeof window.appRouter.loadPage === 'function') {
                    window.appRouter.loadPage(page, true, params);
                } else {
                    // Final fallback
                    console.warn('No navigation method available, using hash fallback');
                    const url = page === 'home' ? '#' : `#page=${page}${params}`;
                    window.location.hash = url;
                    window.location.reload();
                }
            };
        }

        // Initialize navigation with retry mechanism
        function initializeNavigation() {
            let retryCount = 0;
            const maxRetries = 10;
            
            function tryInitialize() {
                if (window.appRouter && typeof window.appRouter.loadPage === 'function') {
                    console.log('AppRouter found, setting up navigation wrapper');
                    createNavigateToWrapper();
                } else if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`AppRouter not ready, retry ${retryCount}/${maxRetries}`);
                    setTimeout(tryInitialize, 100);
                } else {
                    console.warn('AppRouter not available after retries, using fallback navigation');
                    ensureNavigateTo();
                }
            }
            
            tryInitialize();
        }

        // Initialize navigation when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeNavigation);
        } else {
            initializeNavigation();
        }

        // Singles page search functions - Make them globally available
        window.performCardSearch = function() {
            if (window.tcgStore && typeof window.tcgStore.performAdvancedSearch === 'function') {
                window.tcgStore.performAdvancedSearch();
            } else {
                console.warn('Advanced search function not available');
            }
        };

        window.toggleAdvancedFilters = function() {
            const filtersPanel = document.getElementById('advanced-filters');
            const chevron = document.getElementById('filter-chevron');
            
            if (filtersPanel && chevron) {
                const isVisible = filtersPanel.style.display !== 'none';
                filtersPanel.style.display = isVisible ? 'none' : 'block';
                chevron.className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            }
        };

        window.clearAllFilters = function() {
            // Clear all filter inputs
            const filterInputs = document.querySelectorAll('#advanced-filters select, #advanced-filters input');
            filterInputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // Clear main search input
            const searchInput = document.getElementById('card-search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Perform search to show all cards
            window.performCardSearch();
        };

        window.searchByCategory = function(category) {
            if (window.tcgStore && typeof window.tcgStore.searchByCategory === 'function') {
                window.tcgStore.searchByCategory(category);
            } else {
                console.warn('Category search function not available');
            }
        };

        window.loadMoreCards = function() {
            if (window.tcgStore && typeof window.tcgStore.loadMoreCards === 'function') {
                window.tcgStore.loadMoreCards();
            } else {
                console.warn('Load more function not available');
            }
        };

        // Also create regular function declarations for backward compatibility
        function performCardSearch() {
            window.performCardSearch();
        }

        function toggleAdvancedFilters() {
            window.toggleAdvancedFilters();
        }

        function clearAllFilters() {
            window.clearAllFilters();
        }

        function searchByCategory(category) {
            window.searchByCategory(category);
        }

        function loadMoreCards() {
            window.loadMoreCards();
        }

        // Currency Toggle Functionality
        let currentCurrency = 'CAD';
        const exchangeRate = 0.74; // CAD to USD conversion rate (approximate)

        function toggleCurrency() {
            const toggleBtn = document.getElementById('currency-toggle-btn');
            
            if (currentCurrency === 'CAD') {
                currentCurrency = 'USD';
                toggleBtn.textContent = 'USD';
                toggleBtn.style.background = 'var(--primary-color)';
                toggleBtn.style.color = 'white';
                toggleBtn.style.borderColor = 'var(--primary-color)';
            } else {
                currentCurrency = 'CAD';
                toggleBtn.textContent = 'CAD';
                toggleBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                toggleBtn.style.color = 'white';
                toggleBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            }
            
            // Save currency preference
            localStorage.setItem('tcg-currency', currentCurrency);
            
            // Update all prices on the page
            updateAllPrices();
            
            // Update shipping text in header
            updateShippingText();
        }

        function convertPrice(price, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return price;
            
            if (fromCurrency === 'CAD' && toCurrency === 'USD') {
                return price * exchangeRate;
            } else if (fromCurrency === 'USD' && toCurrency === 'CAD') {
                return price / exchangeRate;
            }
            
            return price;
        }

        function formatPrice(price, currency = currentCurrency) {
            const symbol = currency === 'USD' ? '$' : '$';
            const formattedPrice = parseFloat(price).toFixed(2);
            return `${symbol}${formattedPrice} ${currency}`;
        }

        function updateAllPrices() {
            // Update all price elements on the page
            const priceElements = document.querySelectorAll('[data-price]');
            priceElements.forEach(element => {
                const originalPrice = parseFloat(element.dataset.price);
                const originalCurrency = element.dataset.currency || 'CAD';
                const convertedPrice = convertPrice(originalPrice, originalCurrency, currentCurrency);
                
                // Update the text content
                if (element.textContent.includes('$')) {
                    element.textContent = formatPrice(convertedPrice);
                }
            });
            
            // Update cart prices if cart is open
            if (window.tcgStore && typeof window.tcgStore.updateCartPrices === 'function') {
                window.tcgStore.updateCartPrices(currentCurrency);
            }
            
            // Update buylist prices if on buylist page
            updateBuylistPrices();
        }

        function updateBuylistPrices() {
            // Update buylist cart totals
            const cashTotal = document.getElementById('buylist-cash-total');
            const creditTotal = document.getElementById('buylist-credit-total');
            
            if (cashTotal && creditTotal) {
                const cashValue = parseFloat(cashTotal.textContent.replace(/[^0-9.]/g, ''));
                const creditValue = parseFloat(creditTotal.textContent.replace(/[^0-9.]/g, ''));
                
                if (!isNaN(cashValue) && !isNaN(creditValue)) {
                    const convertedCash = convertPrice(cashValue, 'CAD', currentCurrency);
                    const convertedCredit = convertPrice(creditValue, 'CAD', currentCurrency);
                    
                    cashTotal.textContent = formatPrice(convertedCash);
                    creditTotal.textContent = formatPrice(convertedCredit);
                }
            }
            
            // Update individual buylist item prices
            const buylistItems = document.querySelectorAll('#current-buylist-items [style*="font-weight: 600"]');
            buylistItems.forEach(item => {
                if (item.textContent.includes('$')) {
                    const price = parseFloat(item.textContent.replace(/[^0-9.]/g, ''));
                    if (!isNaN(price)) {
                        const convertedPrice = convertPrice(price, 'CAD', currentCurrency);
                        item.textContent = formatPrice(convertedPrice);
                    }
                }
            });
        }

        function updateShippingText() {
            const shippingText = document.querySelector('.header-top-right span');
            if (shippingText) {
                const threshold = currentCurrency === 'USD' ? '75' : '100';
                shippingText.innerHTML = `<i class="fas fa-shipping-fast"></i> Free Shipping on Orders $${threshold}+ ${currentCurrency}`;
            }
        }

        // Initialize currency on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved currency preference
            const savedCurrency = localStorage.getItem('tcg-currency');
            if (savedCurrency && savedCurrency !== currentCurrency) {
                currentCurrency = savedCurrency;
                const toggleBtn = document.getElementById('currency-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.textContent = currentCurrency;
                    if (currentCurrency === 'USD') {
                        toggleBtn.style.background = 'var(--primary-color)';
                        toggleBtn.style.color = 'white';
                        toggleBtn.style.borderColor = 'var(--primary-color)';
                    }
                }
                updateShippingText();
            }
        });

        // Make currency functions globally available
        window.toggleCurrency = toggleCurrency;
        window.convertPrice = convertPrice;
        window.formatPrice = formatPrice;
        window.getCurrentCurrency = function() { return currentCurrency; };
    </script>
</body>
</html>
